
# Complete Supabase Analytics Setup

This file contains the complete SQL setup for Kruthika Chat analytics system. Run this in your Supabase SQL Editor.

## Environment Variables Required

Add these to your `.env.local`:

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

## Complete SQL Setup

```sql
-- =====================================
-- COMPLETE SUPABASE ANALYTICS SETUP
-- =====================================

-- Drop existing tables if they exist (for clean setup)
DROP TABLE IF EXISTS public.user_journey_steps CASCADE;
DROP TABLE IF EXISTS public.cookie_consents CASCADE;
DROP TABLE IF EXISTS public.user_analytics CASCADE;
DROP TABLE IF EXISTS public.ad_interactions CASCADE;
DROP TABLE IF EXISTS public.page_views CASCADE;
DROP TABLE IF EXISTS public.user_sessions CASCADE;
DROP TABLE IF EXISTS public.engagement_metrics CASCADE;
DROP TABLE IF EXISTS public.performance_metrics CASCADE;
DROP TABLE IF EXISTS public.ad_revenue_log CASCADE;
DROP TABLE IF EXISTS public.daily_analytics CASCADE;
DROP TABLE IF EXISTS public.daily_activity_log CASCADE;
DROP TABLE IF EXISTS public.messages_log CASCADE;
DROP TABLE IF EXISTS public.app_configurations CASCADE;

-- Core Messages Table
CREATE TABLE public.messages_log (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  message_id TEXT UNIQUE NOT NULL,
  sender_type TEXT NOT NULL CHECK (sender_type IN ('user', 'ai')),
  chat_id TEXT NOT NULL DEFAULT 'kruthika_chat',
  text_content TEXT,
  has_image BOOLEAN DEFAULT FALSE,
  response_time_ms INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Daily Activity Log for DAU tracking
CREATE TABLE public.daily_activity_log (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  activity_date DATE NOT NULL,
  user_pseudo_id TEXT NOT NULL,
  activity_type TEXT DEFAULT 'active',
  device_type TEXT,
  country_code TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  CONSTRAINT unique_daily_user UNIQUE (activity_date, user_pseudo_id)
);

-- User Sessions for session analytics
CREATE TABLE public.user_sessions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  session_id TEXT UNIQUE NOT NULL,
  user_pseudo_id TEXT NOT NULL,
  started_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  ended_at TIMESTAMPTZ,
  duration_seconds INTEGER,
  page_views INTEGER DEFAULT 0,
  messages_sent INTEGER DEFAULT 0,
  device_type TEXT,
  browser TEXT,
  country_code TEXT,
  country_name TEXT,
  timezone TEXT,
  referrer TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Page Views tracking
CREATE TABLE public.page_views (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  session_id TEXT NOT NULL,
  page_path TEXT NOT NULL,
  page_title TEXT,
  viewed_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  time_on_page INTEGER,
  referrer TEXT,
  user_agent TEXT
);

-- Ad Interactions tracking
CREATE TABLE public.ad_interactions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  session_id TEXT NOT NULL,
  ad_type TEXT NOT NULL,
  ad_network TEXT NOT NULL,
  action_type TEXT NOT NULL CHECK (action_type IN ('view', 'click', 'close')),
  page_path TEXT,
  timestamp TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  user_country TEXT,
  device_type TEXT
);

-- User Analytics for device/location data
CREATE TABLE public.user_analytics (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  session_id TEXT NOT NULL,
  user_pseudo_id TEXT NOT NULL,
  country_code TEXT,
  country_name TEXT,
  timezone TEXT,
  device_type TEXT,
  browser TEXT,
  os TEXT,
  screen_resolution TEXT,
  language TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  CONSTRAINT unique_session_analytics UNIQUE (session_id)
);

-- Cookie Consent tracking
CREATE TABLE public.cookie_consents (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  session_id TEXT NOT NULL,
  necessary BOOLEAN DEFAULT TRUE,
  analytics BOOLEAN DEFAULT FALSE,
  advertising BOOLEAN DEFAULT FALSE,
  personalization BOOLEAN DEFAULT FALSE,
  ai_learning BOOLEAN DEFAULT FALSE,
  intimacy_level BOOLEAN DEFAULT FALSE,
  timestamp TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- User Journey Steps
CREATE TABLE public.user_journey_steps (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  session_id TEXT NOT NULL,
  step_name TEXT NOT NULL,
  step_order INTEGER,
  completed_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  page_path TEXT,
  additional_data JSONB
);

-- Daily Analytics aggregated data
CREATE TABLE public.daily_analytics (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  date DATE NOT NULL UNIQUE,
  dau INTEGER DEFAULT 0,
  message_count INTEGER DEFAULT 0,
  error_count INTEGER DEFAULT 0,
  response_time DECIMAL(8,3) DEFAULT 0,
  session_count INTEGER DEFAULT 0,
  bounce_rate DECIMAL(5,2) DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Ad Revenue tracking
CREATE TABLE public.ad_revenue_log (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  date DATE NOT NULL,
  ad_network TEXT NOT NULL,
  ad_type TEXT NOT NULL,
  impressions BIGINT DEFAULT 0,
  clicks BIGINT DEFAULT 0,
  estimated_revenue DECIMAL(10,4) DEFAULT 0,
  cpm DECIMAL(8,4) DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  CONSTRAINT unique_daily_ad_stats UNIQUE (date, ad_network, ad_type)
);

-- App Configurations
CREATE TABLE public.app_configurations (
  id TEXT PRIMARY KEY,
  settings JSONB NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Enable RLS on all tables
ALTER TABLE public.messages_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.daily_activity_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.page_views ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ad_interactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_analytics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.cookie_consents ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_journey_steps ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.daily_analytics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.ad_revenue_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.app_configurations ENABLE ROW LEVEL SECURITY;

-- Create policies for anonymous access
CREATE POLICY "Allow anon access to messages_log" ON public.messages_log FOR ALL USING (true);
CREATE POLICY "Allow anon access to daily_activity_log" ON public.daily_activity_log FOR ALL USING (true);
CREATE POLICY "Allow anon access to user_sessions" ON public.user_sessions FOR ALL USING (true);
CREATE POLICY "Allow anon access to page_views" ON public.page_views FOR ALL USING (true);
CREATE POLICY "Allow anon access to ad_interactions" ON public.ad_interactions FOR ALL USING (true);
CREATE POLICY "Allow anon access to user_analytics" ON public.user_analytics FOR ALL USING (true);
CREATE POLICY "Allow anon access to cookie_consents" ON public.cookie_consents FOR ALL USING (true);
CREATE POLICY "Allow anon access to user_journey_steps" ON public.user_journey_steps FOR ALL USING (true);
CREATE POLICY "Allow anon access to daily_analytics" ON public.daily_analytics FOR ALL USING (true);
CREATE POLICY "Allow anon access to ad_revenue_log" ON public.ad_revenue_log FOR ALL USING (true);
CREATE POLICY "Allow anon access to app_configurations" ON public.app_configurations FOR ALL USING (true);

-- Create indexes for performance
CREATE INDEX idx_messages_log_created_at ON public.messages_log(created_at);
CREATE INDEX idx_messages_log_sender_type ON public.messages_log(sender_type);
CREATE INDEX idx_messages_log_chat_id ON public.messages_log(chat_id);
CREATE INDEX idx_daily_activity_date ON public.daily_activity_log(activity_date);
CREATE INDEX idx_daily_activity_user ON public.daily_activity_log(user_pseudo_id);
CREATE INDEX idx_user_sessions_session_id ON public.user_sessions(session_id);
CREATE INDEX idx_user_sessions_started_at ON public.user_sessions(started_at);
CREATE INDEX idx_user_sessions_is_active ON public.user_sessions(is_active);
CREATE INDEX idx_page_views_session_id ON public.page_views(session_id);
CREATE INDEX idx_page_views_viewed_at ON public.page_views(viewed_at);
CREATE INDEX idx_ad_interactions_timestamp ON public.ad_interactions(timestamp);
CREATE INDEX idx_ad_interactions_action_type ON public.ad_interactions(action_type);
CREATE INDEX idx_user_analytics_session_id ON public.user_analytics(session_id);
CREATE INDEX idx_user_analytics_country ON public.user_analytics(country_code);
CREATE INDEX idx_cookie_consents_timestamp ON public.cookie_consents(timestamp);
CREATE INDEX idx_user_journey_session_id ON public.user_journey_steps(session_id);
CREATE INDEX idx_daily_analytics_date ON public.daily_analytics(date);
CREATE INDEX idx_ad_revenue_date ON public.ad_revenue_log(date);

-- Analytics Functions
CREATE OR REPLACE FUNCTION get_daily_message_counts(start_date DATE)
RETURNS TABLE(date DATE, messages BIGINT)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    DATE_TRUNC('day', ml.created_at AT TIME ZONE 'UTC')::DATE AS date,
    COUNT(ml.id) AS messages
  FROM public.messages_log ml
  WHERE (ml.created_at AT TIME ZONE 'UTC')::DATE >= start_date
  GROUP BY DATE_TRUNC('day', ml.created_at AT TIME ZONE 'UTC')
  ORDER BY date ASC;
END;
$$;

CREATE OR REPLACE FUNCTION get_daily_active_user_counts(start_date DATE)
RETURNS TABLE(date DATE, active_users BIGINT)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    dal.activity_date AS date,
    COUNT(DISTINCT dal.user_pseudo_id) AS active_users
  FROM public.daily_activity_log dal
  WHERE dal.activity_date >= start_date
  GROUP BY dal.activity_date
  ORDER BY date ASC;
END;
$$;

CREATE OR REPLACE FUNCTION get_session_analytics(start_date DATE)
RETURNS TABLE(
  date DATE,
  total_sessions BIGINT,
  avg_session_duration DECIMAL(8,2),
  bounce_rate DECIMAL(5,2)
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    DATE(us.started_at) as date,
    COUNT(us.id) as total_sessions,
    COALESCE(AVG(us.duration_seconds), 0)::DECIMAL(8,2) as avg_session_duration,
    COALESCE((COUNT(CASE WHEN us.messages_sent <= 1 THEN 1 END) * 100.0 / NULLIF(COUNT(us.id), 0)), 0)::DECIMAL(5,2) as bounce_rate
  FROM public.user_sessions us
  WHERE DATE(us.started_at) >= start_date
  GROUP BY DATE(us.started_at)
  ORDER BY date ASC;
END;
$$;

CREATE OR REPLACE FUNCTION get_device_analytics(start_date DATE)
RETURNS TABLE(
  device_type TEXT,
  session_count BIGINT,
  percentage DECIMAL(5,2)
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  WITH device_counts AS (
    SELECT 
      COALESCE(us.device_type, 'unknown') as device,
      COUNT(us.id) as count
    FROM public.user_sessions us
    WHERE DATE(us.started_at) >= start_date
    GROUP BY COALESCE(us.device_type, 'unknown')
  ),
  total_count AS (
    SELECT SUM(count) as total FROM device_counts
  )
  SELECT 
    dc.device as device_type,
    dc.count as session_count,
    COALESCE((dc.count * 100.0 / NULLIF(tc.total, 0)), 0)::DECIMAL(5,2) as percentage
  FROM device_counts dc
  CROSS JOIN total_count tc
  ORDER BY dc.count DESC;
END;
$$;

CREATE OR REPLACE FUNCTION get_hourly_analytics(target_date DATE)
RETURNS TABLE(
  hour INTEGER,
  message_count BIGINT,
  active_users BIGINT
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    EXTRACT(hour FROM ml.created_at)::INTEGER as hour,
    COUNT(ml.id) as message_count,
    COUNT(DISTINCT ml.chat_id) as active_users
  FROM public.messages_log ml
  WHERE DATE(ml.created_at) = target_date
  GROUP BY EXTRACT(hour FROM ml.created_at)
  ORDER BY hour ASC;
END;
$$;

CREATE OR REPLACE FUNCTION increment_session_messages(session_id_param TEXT)
RETURNS void AS $$
BEGIN
  UPDATE public.user_sessions 
  SET messages_sent = COALESCE(messages_sent, 0) + 1,
      is_active = true
  WHERE session_id = session_id_param;
  
  IF NOT FOUND THEN
    INSERT INTO public.user_sessions (session_id, user_pseudo_id, messages_sent)
    VALUES (session_id_param, session_id_param, 1);
  END IF;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION update_daily_analytics_trigger()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.daily_analytics (date, message_count)
  VALUES (DATE(NEW.created_at), 1)
  ON CONFLICT (date) 
  DO UPDATE SET 
    message_count = daily_analytics.message_count + 1,
    updated_at = NOW();
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_daily_analytics
  AFTER INSERT ON public.messages_log
  FOR EACH ROW
  EXECUTE FUNCTION update_daily_analytics_trigger();

-- Grant execute permissions
GRANT EXECUTE ON FUNCTION get_daily_message_counts(DATE) TO anon;
GRANT EXECUTE ON FUNCTION get_daily_active_user_counts(DATE) TO anon;
GRANT EXECUTE ON FUNCTION get_session_analytics(DATE) TO anon;
GRANT EXECUTE ON FUNCTION get_device_analytics(DATE) TO anon;
GRANT EXECUTE ON FUNCTION get_hourly_analytics(DATE) TO anon;
GRANT EXECUTE ON FUNCTION increment_session_messages(TEXT) TO anon;

-- Insert initial configurations
INSERT INTO public.app_configurations (id, settings) VALUES (
  'ad_settings_kruthika_chat_v1', 
  '{
    "adsEnabledGlobally": true,
    "adsterraDirectLink": "https://www.profitablecpmnetwork.com/g8nhym4yg?key=2b71bf819cb8c5c7f8e011b7b75ea097",
    "adsterraDirectLinkEnabled": true,
    "adsterraBannerCode": "<!-- Adsterra Banner Code Placeholder -->",
    "adsterraBannerEnabled": false,
    "adsterraNativeBannerCode": "<!-- Adsterra Native Banner Code Placeholder -->",
    "adsterraNativeBannerEnabled": false,
    "adsterraSocialBarCode": "<!-- Adsterra Social Bar Code Placeholder -->",
    "adsterraSocialBarEnabled": true,
    "adsterraPopunderCode": "<!-- Adsterra Popunder Code Placeholder -->",
    "adsterraPopunderEnabled": false,
    "maxDirectLinkAdsPerDay": 8,
    "maxDirectLinkAdsPerSession": 2,
    "messagesPerAdTrigger": 7,
    "inactivityAdTimeoutMs": 45000,
    "inactivityAdChance": 0.25,
    "userMediaInterstitialChance": 0.15
  }'
) ON CONFLICT (id) DO UPDATE SET 
  settings = EXCLUDED.settings,
  updated_at = NOW();

INSERT INTO public.app_configurations (id, settings) VALUES (
  'ai_profile_global_v1', 
  '{
    "name": "Kruthika",
    "avatarUrl": "https://placehold.co/100x100.png/E91E63/FFFFFF?text=K",
    "status": "🌸 Living my best life! Lets chat! 🌸",
    "statusStoryText": "Ask me anything! 💬",
    "statusStoryHasUpdate": true
  }'
) ON CONFLICT (id) DO UPDATE SET 
  settings = EXCLUDED.settings,
  updated_at = NOW();

INSERT INTO public.app_configurations (id, settings) VALUES (
  'analytics_config', 
  '{
    "enabled": true,
    "trackingEnabled": true,
    "realTimeUpdates": true,
    "dataRetentionDays": 90
  }'
) ON CONFLICT (id) DO UPDATE SET 
  settings = EXCLUDED.settings,
  updated_at = NOW();
```

## Testing the Setup

After running the SQL, test the connection with:

```sql
-- Test queries
SELECT COUNT(*) FROM public.messages_log;
SELECT COUNT(*) FROM public.daily_activity_log;
SELECT COUNT(*) FROM public.user_sessions;
SELECT * FROM public.app_configurations;
```

## Next Steps

1. Run the complete SQL in your Supabase SQL Editor
2. Verify all tables are created successfully
3. Check that the environment variables are set correctly
4. Restart your Next.js application

Your analytics should now work with real data tracking!
## Secure RLS Policies for Production

**CRITICAL: Run these policies in Supabase SQL Editor after creating your admin user**

```sql
-- REMOVE these insecure policies:
DROP POLICY IF EXISTS "Allow anon inserts for app configurations - PROTOTYPE ONLY - REMOVE FOR PROD" ON public.app_configurations;
DROP POLICY IF EXISTS "Allow anon UPDATES for app configurations - EXTREMELY DANGEROUS - REMOVE FOR PROD" ON public.app_configurations;

-- ADD secure policies (I have replaced 'YOUR_ADMIN_UID' with the real admin UID):
CREATE POLICY "Allow ADMIN to insert configurations"
ON public.app_configurations
FOR INSERT
WITH CHECK (auth.uid() = 'YOUR_ADMIN_UID');

CREATE POLICY "Allow ADMIN to update configurations"
ON public.app_configurations
FOR UPDATE
USING (auth.uid() = 'YOUR_ADMIN_UID')
WITH CHECK (auth.uid() = 'YOUR_ADMIN_UID');
```

**Steps to implement:**
1. Go to Supabase Dashboard → Authentication → Users
2. Create your admin user or find existing user
3. Copy the UID from the user details
4. Replace 'YOUR_ADMIN_UID' in the SQL above with the actual UID
5. Run the SQL in Supabase SQL Editor

**Note:** After implementing these policies, only the authenticated admin user will be able to modify global configurations. Anonymous users will still be able to read configurations (required for the app to function).
