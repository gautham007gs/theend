
# Supabase Setup for Kruthika Chat Analytics & Configuration

This guide explains how to set up a Supabase project to:
1.  Collect analytics (like total messages and daily active user estimates) for your Kruthika Chat application.
2.  Store and manage global application configurations, such as Ad Settings, so they are universal for all users.

## 1. Create a Supabase Account and Project

1.  Go to [supabase.com](https://supabase.com/) and sign up for a free account if you don't have one.
2.  Create a new project. Choose a name, generate a strong database password (save this securely!), and select a region. The free tier is sufficient for this setup.

## 2. Get Your Project URL and Anon Key

Once your project is created:

1.  Navigate to your project dashboard in Supabase.
2.  Go to **Project Settings** (usually a gear icon).
3.  Click on **API**.
4.  You will find your **Project URL** and the **Project API Key** (specifically, the `anon` `public` key).
5.  Copy these values.

## 3. Configure Environment Variables

In your Kruthika Chat project, open the `.env.local` file (or create one if it doesn't exist at the root of your project for local development). For deployment (e.g., Vercel), set these in your hosting provider's environment variable settings. Add the following lines, replacing the placeholders with the values you copied from Supabase:

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url_here
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_project_anon_key_here

# Make sure your GOOGLE_API_KEY is also set for Genkit
GOOGLE_API_KEY=your_gemini_api_key_here
```

**Important:** Do **not** commit the `.env.local` file with real keys to your Git repository if it contains secrets.

## 4. Create Database Tables and Functions

The application is configured to log messages, daily activity, and store global configurations. You need to create these in your Supabase database.

1.  In your Supabase project dashboard, go to the **SQL Editor** (looks like an SQL query icon).
2.  Click **"+ New query"**.
3.  Paste the following SQL code in sections and click **"RUN"** for each section.

**Section 1: `messages_log` Table and Related Function (for message counts)**

```sql
-- Create the messages_log table
CREATE TABLE public.messages_log (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  message_id TEXT,
  sender_type TEXT, -- 'user' or 'ai'
  chat_id TEXT,     -- e.g., 'kruthika_chat' to identify this specific chat instance
  text_content TEXT, -- Store a snippet of the message text
  has_image BOOLEAN DEFAULT FALSE
);

-- Add comments on columns for clarity
COMMENT ON COLUMN public.messages_log.created_at IS 'Timestamp of when the log entry was created';
COMMENT ON COLUMN public.messages_log.message_id IS 'Unique ID of the original message from the chat';
COMMENT ON COLUMN public.messages_log.sender_type IS 'Indicates if the message was from a "user" or "ai"';
COMMENT ON COLUMN public.messages_log.chat_id IS 'Identifier for the chat session or AI character (e.g., kruthika_chat, kruthika_chat_offline_ping)';
COMMENT ON COLUMN public.messages_log.text_content IS 'Content of the message (can be truncated)';
COMMENT ON COLUMN public.messages_log.has_image IS 'Indicates if the message included an image';

-- Enable Row Level Security (RLS) on the new table.
ALTER TABLE public.messages_log ENABLE ROW LEVEL SECURITY;

-- Create a policy that allows anonymous users to insert into messages_log.
-- For production, consider tightening this:
-- e.g., `WITH CHECK (chat_id = 'kruthika_chat')`
-- or if user authentication is implemented for chat: `WITH CHECK (auth.role() = 'authenticated' AND user_id_column = auth.uid())`
CREATE POLICY "Allow anon inserts for message logging - REVIEW FOR PRODUCTION"
ON public.messages_log
FOR INSERT
WITH CHECK (chat_id IN ('kruthika_chat', 'kruthika_chat_offline_ping')); -- Example: Restrict by chat_id

-- Create a policy that allows anonymous users (like your admin page IF NOT YET FULLY SECURED) to read from messages_log for analytics.
-- For production with a secured admin panel, this should be restricted to admin roles.
-- e.g., `USING (auth.role() = 'admin_user_role')`
CREATE POLICY "Allow anon reads for analytics - REVIEW FOR PRODUCTION"
ON public.messages_log
FOR SELECT
USING (true); -- DANGER: If admin panel isn't secured, this is open.

-- Create a PostgreSQL function to get daily message counts (user and AI)
CREATE OR REPLACE FUNCTION get_daily_message_counts(start_date DATE)
RETURNS TABLE(date DATE, messages BIGINT)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    DATE_TRUNC('day', ml.created_at AT TIME ZONE 'UTC')::DATE AS date,
    COUNT(ml.id) AS messages
  FROM public.messages_log ml
  WHERE (ml.created_at AT TIME ZONE 'UTC')::DATE >= start_date
  GROUP BY DATE_TRUNC('day', ml.created_at AT TIME ZONE 'UTC')
  ORDER BY date ASC;
END;
$$;
```
**Data Retention Note for `messages_log`:**
This table can grow very large. Consider deleting logs older than your chosen retention period (e.g., `DELETE FROM public.messages_log WHERE created_at < NOW() - INTERVAL '90 days';`).

**Section 2: `daily_activity_log` Table and Related Function (for DAU)**
```sql
CREATE TABLE public.daily_activity_log (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_pseudo_id TEXT NOT NULL,
  activity_date DATE NOT NULL,
  chat_id TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  CONSTRAINT unique_user_activity_per_day_per_chat UNIQUE (user_pseudo_id, activity_date, chat_id)
);
COMMENT ON COLUMN public.daily_activity_log.chat_id IS 'Identifier for the chat application (e.g., kruthika_chat).';
ALTER TABLE public.daily_activity_log ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow anon inserts for daily activity - REVIEW FOR PRODUCTION"
ON public.daily_activity_log
FOR INSERT
WITH CHECK (chat_id = 'kruthika_chat'); -- Example: Restrict by chat_id

CREATE POLICY "Allow anon reads for DAU analytics - REVIEW FOR PRODUCTION"
ON public.daily_activity_log
FOR SELECT
USING (true); -- DANGER: If admin panel isn't secured, this is open.

CREATE OR REPLACE FUNCTION get_daily_active_user_counts(start_date DATE)
RETURNS TABLE(date DATE, active_users BIGINT)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    dal.activity_date AS date,
    COUNT(DISTINCT dal.user_pseudo_id) AS active_users
  FROM public.daily_activity_log dal
  WHERE dal.activity_date >= start_date
  AND dal.chat_id = 'kruthika_chat'
  GROUP BY dal.activity_date
  ORDER BY date ASC;
END;
$$;
```

**Section 3: `app_configurations` Table (for Global Ad Settings, etc.)**
```sql
CREATE TABLE public.app_configurations (
  id TEXT PRIMARY KEY,
  settings JSONB NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
COMMENT ON COLUMN public.app_configurations.id IS 'Unique identifier for the configuration';
COMMENT ON COLUMN public.app_configurations.settings IS 'The actual configuration object stored as JSONB';
ALTER TABLE public.app_configurations ENABLE ROW LEVEL SECURITY;

-- Policy: Allow ALL users (including anonymous) to READ configurations.
-- This is necessary for the app to fetch settings like AI Profile, Ad Settings, etc., for all users.
CREATE POLICY "Allow anon reads for app configurations"
ON public.app_configurations
FOR SELECT
USING (true);

-- !! CRITICAL - SECURE WRITE ACCESS TO APP CONFIGURATIONS !!
-- Remove or disable the "PROTOTYPE ONLY" INSERT and UPDATE policies below.
-- Replace them with policies that restrict write access to your authenticated admin user.

-- TO REMOVE OLD INSECURE POLICIES (RUN THESE IF THEY EXIST):
-- DROP POLICY IF EXISTS "Allow anon inserts for app configurations - PROTOTYPE ONLY" ON public.app_configurations;
-- DROP POLICY IF EXISTS "Allow anon UPDATES for app configurations - EXTREMELY DANGEROUS FOR PRODUCTION - PROTOTYPE ONLY" ON public.app_configurations;
-- DROP POLICY IF EXISTS "Allow anon inserts for app configurations - PROTOTYPE ONLY - REMOVE FOR PROD" ON public.app_configurations;
-- DROP POLICY IF EXISTS "Allow anon UPDATES for app configurations - EXTREMELY DANGEROUS - REMOVE FOR PROD" ON public.app_configurations;


-- OPTION 1: Restrict by a specific Admin User ID (UID)
-- Get your admin user's UID from Supabase Authentication dashboard (Users -> find your admin -> copy UID)
-- Replace 'your_admin_user_id_here' with the actual UID.
/*
CREATE POLICY "Allow ADMIN (by UID) to insert configurations"
ON public.app_configurations
FOR INSERT
WITH CHECK (auth.uid() = 'your_admin_user_id_here');

CREATE POLICY "Allow ADMIN (by UID) to update configurations"
ON public.app_configurations
FOR UPDATE
USING (auth.uid() = 'your_admin_user_id_here')
WITH CHECK (auth.uid() = 'your_admin_user_id_here');
*/

-- OPTION 2: Restrict by an Admin Role
-- This assumes you have set up roles in Supabase (e.g., using custom claims or a roles table).
-- Replace 'admin_role' with the actual name of your admin role.
/*
CREATE POLICY "Allow ADMIN (by role) to insert configurations"
ON public.app_configurations
FOR INSERT
WITH CHECK (auth.role() = 'admin_role'); -- Or a function checking custom claims: get_my_claim('app_role') = '"admin"'

CREATE POLICY "Allow ADMIN (by role) to update configurations"
ON public.app_configurations
FOR UPDATE
USING (auth.role() = 'admin_role') -- Or function like get_my_claim('app_role') = '"admin"'
WITH CHECK (auth.role() = 'admin_role'); -- Or function like get_my_claim('app_role') = '"admin"'
*/

-- IF YOU ARE STILL IN EARLY DEVELOPMENT AND NEED TO KEEP THE PROTOTYPE POLICIES TEMPORARILY,
-- RENAME THEM TO MAKE IT CLEAR THEY ARE NOT FOR PRODUCTION:
CREATE POLICY "Allow anon inserts for app configurations - PROTOTYPE ONLY - REMOVE FOR PROD"
ON public.app_configurations
FOR INSERT
WITH CHECK (true); -- DANGER: REMOVE/REPLACE.

CREATE POLICY "Allow anon UPDATES for app configurations - EXTREMELY DANGEROUS - REMOVE FOR PROD"
ON public.app_configurations
FOR UPDATE
USING (true)
WITH CHECK (true); -- DANGER: REMOVE/REPLACE.

-- =============================================
-- STORAGE BUCKET POLICIES FOR FILE UPLOADS
-- =============================================
-- These policies allow file uploads to storage buckets.
-- ⚠️ WARNING: These are PROTOTYPE policies allowing anonymous uploads.
-- For production, implement proper authentication and restrict by user ID.

-- Policy for media-images bucket
CREATE POLICY "Allow anon uploads to media-images - PROTOTYPE ONLY"
ON storage.objects FOR INSERT
WITH CHECK (bucket_id = 'media-images');

CREATE POLICY "Allow public read from media-images"
ON storage.objects FOR SELECT
USING (bucket_id = 'media-images');

CREATE POLICY "Allow anon delete from media-images - PROTOTYPE ONLY"
ON storage.objects FOR DELETE
USING (bucket_id = 'media-images');

-- Policy for media-audio bucket
CREATE POLICY "Allow anon uploads to media-audio - PROTOTYPE ONLY"
ON storage.objects FOR INSERT
WITH CHECK (bucket_id = 'media-audio');

CREATE POLICY "Allow public read from media-audio"
ON storage.objects FOR SELECT
USING (bucket_id = 'media-audio');

CREATE POLICY "Allow anon delete from media-audio - PROTOTYPE ONLY"
ON storage.objects FOR DELETE
USING (bucket_id = 'media-audio');

-- Policy for media-videos bucket
CREATE POLICY "Allow anon uploads to media-videos - PROTOTYPE ONLY"
ON storage.objects FOR INSERT
WITH CHECK (bucket_id = 'media-videos');

CREATE POLICY "Allow public read from media-videos"
ON storage.objects FOR SELECT
USING (bucket_id = 'media-videos');

CREATE POLICY "Allow anon delete from media-videos - PROTOTYPE ONLY"
ON storage.objects FOR DELETE
USING (bucket_id = 'media-videos');


-- Example: To insert initial ad_settings (can be done from Admin Panel save, or run this manually once after table creation)
-- Make sure the RLS policies allow your admin user to perform this insert.
/*
INSERT INTO public.app_configurations (id, settings)
VALUES ('ad_settings_kruthika_chat_v1', '{
  "adsEnabledGlobally": true,
  "adsterraDirectLink": "YOUR_ADSTERRA_DEFAULT_LINK_HERE",
  "adsterraDirectLinkEnabled": true,
  "adsterraBannerCode": "<!-- Adsterra Banner Code Placeholder -->",
  "adsterraBannerEnabled": false,
  "adsterraNativeBannerCode": "<!-- Adsterra Native Banner Code Placeholder -->",
  "adsterraNativeBannerEnabled": false,
  "adsterraSocialBarCode": "<!-- Adsterra Social Bar Code Placeholder -->",
  "adsterraSocialBarEnabled": false,
  "adsterraPopunderCode": "<!-- Adsterra Pop-under Script Placeholder -->",
  "adsterraPopunderEnabled": false,
  "monetagDirectLink": "YOUR_MONETAG_DEFAULT_LINK_HERE",
  "monetagDirectLinkEnabled": true,
  "monetagBannerCode": "<!-- Monetag Banner Code Placeholder -->",
  "monetagBannerEnabled": false,
  "monetagNativeBannerCode": "<!-- Monetag Native Banner Code Placeholder -->",
  "monetagNativeBannerEnabled": false,
  "monetagSocialBarCode": "<!-- Monetag Social Bar Code Placeholder -->",
  "monetagSocialBarEnabled": false,
  "monetagPopunderCode": "<!-- Monetag Pop-under Script Placeholder -->",
  "monetagPopunderEnabled": false,
  "maxDirectLinkAdsPerDay": 6,
  "maxDirectLinkAdsPerSession": 3
}');
*/
```

**Section 4: Grant Execute Permissions on Functions**
```sql
GRANT EXECUTE ON FUNCTION get_daily_message_counts(DATE) TO anon;
GRANT EXECUTE ON FUNCTION get_daily_active_user_counts(DATE) TO anon;
```

**Why these policies and functions?**
*   **`messages_log` & `daily_activity_log`:**
    *   The `INSERT` policies are slightly tightened to check `chat_id`.
    *   The `SELECT` policies still allow anonymous reads for analytics on the admin panel. If your admin panel itself is fully secured behind Supabase Auth, you could restrict these reads to admin roles too.
*   **`app_configurations`:**
    *   The `SELECT` policy allows *all* clients to fetch global settings.
    *   **The `INSERT` and `UPDATE` policies MUST BE REPLACED WITH SECURE, ROLE-BASED OR UID-BASED POLICIES FOR PRODUCTION.** The prototype policies allow anyone to change your global settings, which is highly insecure. You must select one of the secure options provided (UID-based or role-based) and implement it.

**CRITICAL Security Note on RLS Policies for Production:**
The Row Level Security (RLS) policies provided above for `app_configurations` (INSERT/UPDATE) and `messages_log`/`daily_activity_log` (INSERT) are **still illustrative**. You **MUST**:
*   Implement proper user authentication for your Admin Panel (as done by changing the login page).
*   For `app_configurations`, **CHOOSE AND IMPLEMENT** one of the secure `INSERT` and `UPDATE` policies (UID-based or Role-based) and **DELETE OR DISABLE** the "PROTOTYPE ONLY" policies.
*   Review Supabase's official documentation on RLS and security best practices thoroughly before going live.

## 5. Restart Your Application

After setting environment variables, running SQL, and deploying any code changes, your application should reflect the new security model for the admin panel.

## Troubleshooting

*   **Admin Login Fails:**
    *   Ensure the user `gamingguruji095@gmail.com` (or your admin email) exists in Supabase Auth with the correct password.
    *   Check browser console for errors from Supabase.
*   **Cannot Save Admin Settings:**
    *   This means your RLS policies for `app_configurations` are not correctly set up to allow your authenticated admin user to write. Double-check the UID or role in your policies.
    *   Check Supabase Logs (Database -> Logs, or API -> PostgREST logs) for RLS violation errors.
*   **Other Supabase Issues:** Check browser console and Supabase logs.

This setup moves towards a more secure admin panel. Remember to use strong, unique passwords and keep your Supabase project secure.

    