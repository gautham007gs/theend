
-- Create the messages_log table
CREATE TABLE IF NOT EXISTS public.messages_log (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  message_id TEXT,
  sender_type TEXT, -- 'user' or 'ai'
  chat_id TEXT,     -- e.g., 'kruthika_chat' to identify this specific chat instance
  text_content TEXT, -- Store a snippet of the message text
  has_image BOOLEAN DEFAULT FALSE
);

-- Create the daily_activity_log table
CREATE TABLE IF NOT EXISTS public.daily_activity_log (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_pseudo_id TEXT NOT NULL,
  activity_date DATE NOT NULL,
  chat_id TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  CONSTRAINT unique_user_activity_per_day_per_chat UNIQUE (user_pseudo_id, activity_date, chat_id)
);

-- Create the app_configurations table
CREATE TABLE IF NOT EXISTS public.app_configurations (
  id TEXT PRIMARY KEY,
  settings JSONB NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- Enable Row Level Security (RLS) on the new tables
ALTER TABLE public.messages_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.daily_activity_log ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.app_configurations ENABLE ROW LEVEL SECURITY;

-- Drop existing policies if they exist (to prevent duplicate errors)
DROP POLICY IF EXISTS "Allow anon inserts for message logging" ON public.messages_log;
DROP POLICY IF EXISTS "Allow anon reads for analytics" ON public.messages_log;
DROP POLICY IF EXISTS "Allow anon inserts for daily activity" ON public.daily_activity_log;
DROP POLICY IF EXISTS "Allow anon reads for DAU analytics" ON public.daily_activity_log;
DROP POLICY IF EXISTS "Allow anon reads for app configurations" ON public.app_configurations;
DROP POLICY IF EXISTS "Allow anon inserts for app configurations" ON public.app_configurations;
DROP POLICY IF EXISTS "Allow anon updates for app configurations" ON public.app_configurations;

-- Create policies that allow anonymous users to insert/read (for development)
CREATE POLICY "Allow anon inserts for message logging" ON public.messages_log
FOR INSERT WITH CHECK (true);

CREATE POLICY "Allow anon reads for analytics" ON public.messages_log
FOR SELECT USING (true);

CREATE POLICY "Allow anon inserts for daily activity" ON public.daily_activity_log
FOR INSERT WITH CHECK (true);

CREATE POLICY "Allow anon reads for DAU analytics" ON public.daily_activity_log
FOR SELECT USING (true);

CREATE POLICY "Allow anon reads for app configurations" ON public.app_configurations
FOR SELECT USING (true);

CREATE POLICY "Allow anon inserts for app configurations" ON public.app_configurations
FOR INSERT WITH CHECK (true);

CREATE POLICY "Allow anon updates for app configurations" ON public.app_configurations
FOR UPDATE USING (true) WITH CHECK (true);

-- Create PostgreSQL functions for analytics
CREATE OR REPLACE FUNCTION get_daily_message_counts(start_date DATE)
RETURNS TABLE(date DATE, messages BIGINT)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    DATE_TRUNC('day', ml.created_at AT TIME ZONE 'UTC')::DATE AS date,
    COUNT(ml.id) AS messages
  FROM public.messages_log ml
  WHERE (ml.created_at AT TIME ZONE 'UTC')::DATE >= start_date
  GROUP BY DATE_TRUNC('day', ml.created_at AT TIME ZONE 'UTC')
  ORDER BY date ASC;
END;
$$;

CREATE OR REPLACE FUNCTION get_daily_active_user_counts(start_date DATE)
RETURNS TABLE(date DATE, active_users BIGINT)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    dal.activity_date AS date,
    COUNT(DISTINCT dal.user_pseudo_id) AS active_users
  FROM public.daily_activity_log dal
  WHERE dal.activity_date >= start_date
  GROUP BY dal.activity_date
  ORDER BY date ASC;
END;
$$;

-- Grant execute permissions on functions to anon role
GRANT EXECUTE ON FUNCTION get_daily_message_counts(DATE) TO anon;
GRANT EXECUTE ON FUNCTION get_daily_active_user_counts(DATE) TO anon;

-- Insert initial ad settings configuration
INSERT INTO public.app_configurations (id, settings) VALUES (
  'ad_settings_kruthika_chat_v1', 
  '{
    "adsEnabledGlobally": true,
    "adsterraDirectLink": "https://www.profitablecpmnetwork.com/g8nhym4yg?key=2b71bf819cb8c5c7f8e011b7b75ea097",
    "adsterraDirectLinkEnabled": true,
    "adsterraBannerCode": "<!-- Adsterra Banner Code Placeholder -->",
    "adsterraBannerEnabled": false,
    "adsterraNativeBannerCode": "<!-- Adsterra Native Banner Code Placeholder -->",
    "adsterraNativeBannerEnabled": false,
    "adsterraSocialBarCode": "<!-- Adsterra Social Bar Code Placeholder -->",
    "adsterraSocialBarEnabled": true,
    "adsterraPopunderCode": "<!-- Adsterra Popunder Code Placeholder -->",
    "adsterraPopunderEnabled": false,
    "monetagDirectLink": "https://example.com/monetag",
    "monetagDirectLinkEnabled": false,
    "monetagBannerCode": "<!-- Monetag Banner Code Placeholder -->",
    "monetagBannerEnabled": false,
    "monetagNativeBannerCode": "<!-- Monetag Native Banner Code Placeholder -->",
    "monetagNativeBannerEnabled": false,
    "monetagSocialBarCode": "<!-- Monetag Social Bar Code Placeholder -->",
    "monetagSocialBarEnabled": false,
    "monetagPopunderCode": "<!-- Monetag Popunder Code Placeholder -->",
    "monetagPopunderEnabled": false,
    "maxDirectLinkAdsPerDay": 8,
    "maxDirectLinkAdsPerSession": 2,
    "messagesPerAdTrigger": 7,
    "inactivityAdTimeoutMs": 45000,
    "inactivityAdChance": 0.25,
    "userMediaInterstitialChance": 0.15
  }'
) ON CONFLICT (id) DO UPDATE SET 
  settings = EXCLUDED.settings,
  updated_at = NOW();


SELECT id, COUNT(*) as count FROM app_configurations GROUP BY id HAVING COUNT(*) > 1; -- If duplicates exist, keep only the most recent one DELETE FROM app_configurations a USING app_configurations b WHERE a.id = b.id AND a.updated_at < b.updated_at;"



CREATE TABLE sent_media (
  id BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
  user_id TEXT NOT NULL,
  media_url TEXT NOT NULL,
  sent_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (user_id, media_url)
);





-- Additional optimizations for your current SQL setup

-- Add indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_messages_log_created_at ON public.messages_log(created_at);
CREATE INDEX IF NOT EXISTS idx_messages_log_chat_id ON public.messages_log(chat_id);
CREATE INDEX IF NOT EXISTS idx_daily_activity_date ON public.daily_activity_log(activity_date);
CREATE INDEX IF NOT EXISTS idx_daily_activity_user_chat ON public.daily_activity_log(user_pseudo_id, chat_id);

-- Add a function to clean old data (helps manage costs)
CREATE OR REPLACE FUNCTION cleanup_old_messages(days_to_keep INTEGER DEFAULT 90)
RETURNS INTEGER
LANGUAGE plpgsql
AS $$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM public.messages_log 
  WHERE created_at < NOW() - INTERVAL '1 day' * days_to_keep;

  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$$;

-- Grant permissions
GRANT EXECUTE ON FUNCTION cleanup_old_messages(INTEGER) TO anon;

-- Add revenue tracking table for better ad analytics
CREATE TABLE IF NOT EXISTS public.ad_revenue_log (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  date DATE NOT NULL,
  ad_network TEXT NOT NULL, -- 'adsterra', 'monetag'
  ad_type TEXT NOT NULL, -- 'banner', 'native', 'social', 'popunder'
  impressions BIGINT DEFAULT 0,
  clicks BIGINT DEFAULT 0,
  estimated_revenue DECIMAL(10,4) DEFAULT 0,
  cpm DECIMAL(8,4) DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  CONSTRAINT unique_daily_ad_stats UNIQUE (date, ad_network, ad_type)
);

ALTER TABLE public.ad_revenue_log ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow anon inserts for ad revenue" ON public.ad_revenue_log
FOR INSERT WITH CHECK (true);

CREATE POLICY "Allow anon reads for ad revenue" ON public.ad_revenue_log
FOR SELECT USING (true);

CREATE POLICY "Allow anon updates for ad revenue" ON public.ad_revenue_log
FOR UPDATE USING (true) WITH CHECK (true);



-- Add the missing daily_analytics table that's referenced in database-optimizer.ts
CREATE TABLE IF NOT EXISTS public.daily_analytics (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  date DATE NOT NULL UNIQUE,
  dau INTEGER DEFAULT 0,
  message_count INTEGER DEFAULT 0,
  error_count INTEGER DEFAULT 0,
  response_time DECIMAL(8,3) DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

ALTER TABLE public.daily_analytics ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow anon inserts for daily analytics" ON public.daily_analytics
FOR INSERT WITH CHECK (true);

CREATE POLICY "Allow anon reads for daily analytics" ON public.daily_analytics
FOR SELECT USING (true);

CREATE POLICY "Allow anon updates for daily analytics" ON public.daily_analytics
FOR UPDATE USING (true) WITH CHECK (true);

-- Add index for better performance
CREATE INDEX IF NOT EXISTS idx_daily_analytics_date ON public.daily_analytics(date);

-- Add the AI profile configuration that your app expects
INSERT INTO public.app_configurations (id, settings) VALUES (
  'ai_profile_global_v1', 
  '{
    "name": "Kruthika",
    "avatarUrl": "https://placehold.co/100x100.png/E91E63/FFFFFF?text=K",
    "status": "ðŸŒ¸ Living my best life! Lets chat! ðŸŒ¸",
    "statusStoryText": "Ask me anything! ðŸ’¬",
    "statusStoryHasUpdate": true
  }'
) ON CONFLICT (id) DO UPDATE SET 
  settings = EXCLUDED.settings,
  updated_at = NOW();

-- Add analytics configuration
INSERT INTO public.app_configurations (id, settings) VALUES (
  'analytics_config', 
  '{
    "enabled": true,
    "trackingEnabled": true,
    "realTimeUpdates": true,
    "dataRetentionDays": 90
  }'
) ON CONFLICT (id) DO UPDATE SET 
  settings = EXCLUDED.settings,
  updated_at = NOW();

-- Grant permissions on the new table
GRANT EXECUTE ON FUNCTION cleanup_old_messages(INTEGER) TO anon;

